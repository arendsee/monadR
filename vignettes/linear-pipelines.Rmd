---
title: "Rmonad: passing state through linear pipelines"
author: "Zebulun Arendsee"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Linear Pipelines}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, echo=FALSE, message=FALSE}
library(rmonad)
library(magrittr)
library(tibble)
library(ggplot2)
set.seed(210)
```


I will introduce `Rmonad` with a simple sequence of squares

```{r}
# %>>% corresponds to Haskell's >>=
1:5      %>>%
    sqrt %>>%
    sqrt %>>%
    sqrt
```

So what exactly did Rmonad do with your data? It is still there, sitting
happily inside the monad.

In `magrittr` you could do something similar:

```{r}
1:5      %>%
    sqrt %>%
    sqrt %>%
    sqrt
```

`%>%` takes the value on the left and applies it to the function on the right.
`%>>%`, takes a monad on the left and a function on the right, then builds a
new monad from them. This new monad holds the computed value, if the
computation succeeded. It collates all errors, warnings, and messages.  These
are stored in step-by-step a history of the pipeline.

`%>%` is an application operator, `%>>%` is a *monadic bind* operator. Magrittr
and Rmonad complement eachother. `%>%` can be used inside a monadic sequence to
perform operations *on* monads, whereas `%>>%` performs operations *in* them.
If this is all too mystical, just hold on, the examples are sensical even
without an understanding of monads.

Below, we store an intermediate value in the monad:

```{r}
1:5      %>>%
    sqrt %v>% # store this result
    sqrt %>>%
    sqrt
```

The `%v>%` variant of the *monadic bind* operator stores the results as they
are passed.

Warnings are caught and stored

```{r}
-1:3     %>>%
    sqrt %v>%
    sqrt %>>%
    sqrt
```

Similarly for errors

```{r}
"wrench" %>>%
    sqrt %v>%
    sqrt %>>%
    sqrt
```

The first `sqrt` failed, and this step was coupled to the resultant error.
Contrast this with `magrittr`, where the location of the error is lost:

```{r, error=TRUE}
"wrench" %>>%
    sqrt %>%
    sqrt %>%
    sqrt
```

Also note that a value was still produced. `Rmonad` stores the last successful
value. It will never use this value, though. If you want to extract the result
from the monad, you can use the `esc` function:

```{r}
1:5 %>>% sqrt %>% esc
```

Note the use of `%>%` not `%>>%`, this is because `esc` acts on the monad, not
the value the monad stores. If the monad is in a failed state, `esc` will raise
an error.


```{r, error=TRUE}
"wrench" %>>% sqrt %>>% sqrt %>% esc
```

If you prefer a tabular summary of your results, you can pipe the monad into
the `mtabulate` function.

```{r}
1:5      %>>%
    sqrt %v>%
    sqrt %>>%
    sqrt %>% mtabulate
```

Here is a more substantial example

```{r}
# convert to tibbles for cleaner printing
r1 <- read.table("asdfdf") %>>% tibble::as_tibble %>>% colSums %>>% mean
r2 <- iris %>>% tibble::as_tibble %>>% colSums %>>% mean
r3 <- cars %>>% tibble::as_tibble %>>% colSums %>>% mean
```
