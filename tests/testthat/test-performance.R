context("performance and scale")

u <- function(x) { x + 1 }

long <- function(x) {
  x %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u
}

superlong <- function(x) {
  1 %>>%

  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>%
  u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>>% u %>% esc

}

test_that('rmonad will handle 100 nodes in less than a second', {
  expect_true(
    system.time(
      1 %>>% long
    )[1] < 1
  )
})

test_that('rmonad will handle very large systems', {
  expect_equal(superlong(), 1001)
})
